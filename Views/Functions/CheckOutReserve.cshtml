@model IEnumerable<BRMSBS_capstoneproject.Models.BookingModel>

@{
    ViewData["Title"] = "Check Out";
    Layout = "~/Views/Layouts/CheckOutReserveLayout.cshtml";

    var bookingsList = Model != null
        ? Model.Where(b => string.Equals(b.BookReserve, "Booking", StringComparison.OrdinalIgnoreCase)).ToList()
        : new List<BRMSBS_capstoneproject.Models.BookingModel>();

    var reservesList = Model != null
        ? Model.Where(b => string.Equals(b.BookReserve, "Reserve", StringComparison.OrdinalIgnoreCase) || string.Equals(b.BookReserve, "Reservation", StringComparison.OrdinalIgnoreCase)).ToList()
        : new List<BRMSBS_capstoneproject.Models.BookingModel>();
}

<div class="text-ctr"><b> Manage Reservation Check-Out </b></div>

<div class="containerbox">
    @if (reservesList.Any())
    {
        <h5>Reservations</h5>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Book/Reserve</th>
                    <th>Room Number</th>
                    <th>Last Name</th>
                    <th>Arrival Date</th>
                    <th>Departure Date</th>
                    <th>Access By</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in reservesList)
                {
                    <tr>
                        <td>
                            @* Reservations typically don't perform immediate checkout, however allow Checkout when arrival date is today or earlier *@
                            @{
                                var canCheckout = booking.ArrivalDate.Date <= DateTime.Today;
                            }
                            @if (canCheckout)
                            {
                                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#checkoutPriceModal-@booking.Id">Check Out</button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-success btn-sm disabled" title="Check out not available for reservations">Check Out</button>
                            }
                            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#infoModal-@booking.Id">Info</button>
                        </td>
                        <td>@booking.Id</td>
                        <td>@booking.Status</td>
                        <td>@booking.BookReserve</td>
                        <td>@booking.RoomNumber</td>
                        <td>@booking.LastName</td>
                        <td>@booking.ArrivalDate.ToString("M/d/yy")</td>
                        <td>@booking.DepartureDate.ToString("M/d/yy")</td>
                        <td>@booking.AccessBy</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="text-center text-muted">No reservations found.</div>
    }
</div>

<!-- Check Out Price Modal -->
@foreach (var booking in Model)
{
    var roomRates = Convert.ToInt32(booking.RoomRates);
    var stayingDays = (booking.DepartureDate - booking.ArrivalDate).Days; 
    var total = stayingDays * roomRates;
    <span id="arrivalDate-@booking.Id" style="display:none">@booking.ArrivalDate.ToString("yyyy-MM-dd")</span>
    <div class="modal fade" id="checkoutPriceModal-@booking.Id" tabindex="-1" aria-labelledby="checkoutPriceModalLabel-@booking.Id" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkoutPriceModalLabel-@booking.Id">Check Out Booking</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <dl class="row">
                        <dt class="col-sm-3">ID</dt>
                        <dd class="col-sm-9">@booking.Id</dd>
                        <dt class="col-sm-3">First Name</dt>
                        <dd class="col-sm-9">@booking.FirstName</dd>
                        <dt class="col-sm-3">Last Name</dt>
                        <dd class="col-sm-9">@booking.LastName</dd>
                        <dt class="col-sm-3">Book/Reserve</dt>
                        <dd class="col-sm-9">@booking.BookReserve</dd>
                        <dt class="col-sm-3">Check-In Date</dt>
                        <dd class="col-sm-9">@booking.ArrivalDate.ToString("yyyy-MM-dd")</dd>
                        <dt class="col-sm-3">Check-Out Date</dt>
                        <dd class="col-sm-9">@booking.DepartureDate.ToString("yyyy-MM-dd")</dd>
                        <dt class="col-sm-3">Room Number</dt>
                        <dd class="col-sm-9">@booking.RoomNumber</dd>
                        <dt class="col-sm-3">Room Type</dt>
                        <dd class="col-sm-9">@booking.RoomType</dd>
                    </dl class="row">
                    ----------------------------------------------------------
                    <dl class="row">
                        <dt class="col-sm-5">Number of Pax</dt>
                        <dd class="col-sm-7">@booking.NumberOfPax.ToString()</dd>
                        <dt class="col-sm-5">Room Rates</dt>
                        <dd class="col-sm-7">@roomRates.ToString("C0", new System.Globalization.CultureInfo("en-PH"))</dd>
                        <dt class="col-sm-5">Staying Days</dt>
                        <dd class="col-sm-7">@stayingDays.ToString() nights</dd>
                        <dt class="col-sm-5">Total Paid (Booking/Extend)</dt>
                        <dd class="col-sm-7"><b>@booking.CashAmount.ToString("C0", new System.Globalization.CultureInfo("en-PH"))</b></dd>
                        <dt class="col-sm-5">Total Change</dt>
                        <dd class="col-sm-7"><b>@booking.CashChange.ToString("C0", new System.Globalization.CultureInfo("en-PH"))</b></dd>
                    </dl>

                    Do you want to check out this selected booking/reservaton?<br/>
                    This action cannot be undone.
                </div>
                    <div class="modal-footer">
                    <!-- remove automatic BS toggles and use class + data attribute for JS control -->
                    <button type="button" class="btn btn-success open-payment-btn" data-booking-id="@booking.Id" data-book-reserve="@booking.BookReserve">Check Out Now</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal: enter cash, see total and change, final submit posts to System/CheckOut -->
    <div class="modal fade" id="paymentModal-@booking.Id" tabindex="-1" aria-labelledby="paymentModalLabel-@booking.Id" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel-@booking.Id">Payment - Booking @booking.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <div id="displayTotal-@booking.Id" class="fw-bold">@total.ToString("C0", new System.Globalization.CultureInfo("en-PH"))</div>
                    </div>

                    <form asp-action="CheckOut" asp-controller="System" asp-route-bookingId="@booking.Id" method="post" id="paymentForm-@booking.Id">
                        <input type="hidden" name="stayingDays" value="@stayingDays" />
                        <input type="hidden" name="grandTotal" value="@total" id="grandTotalHidden-@booking.Id" />
                        <input type="hidden" name="cashChange" value="0" id="cashChangeHidden-@booking.Id" />

                        <div class="mb-3">
                            <label for="cashAmount-@booking.Id" class="form-label">Pay (Enter amount)</label>
                            <input type="number" step="0.01" min="0" class="form-control cash-amount" id="cashAmount-@booking.Id" name="cashAmount" placeholder="0.00" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Change</label>
                        <div id="displayChange-@booking.Id" class="fw-bold">@(0.ToString("C2", new System.Globalization.CultureInfo("en-PH")))</div>
                        </div>

                        <div class="text-muted small">Enter cash amount then click "Confirm Check Out".</div>

                        <div class="modal-footer p-0 mt-3">
                            <button type="submit" class="btn btn-success">Confirm Check Out</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend Modal -->
    <div class="modal fade" id="extendModal-@booking.Id" tabindex="-1" aria-labelledby="extendModalLabel-@booking.Id" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extendModalLabel-@booking.Id">Extend Stay - Booking @booking.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">Original Check-Out Date: <strong id="originalDeparture-@booking.Id">@booking.DepartureDate.ToString("yyyy-MM-dd")</strong></div>

                    @{
                        // Minimum selectable date: at least one day after original departure
                        // and not in the past (use the later of the two)
                        var minAfterOriginal = booking.DepartureDate.AddDays(1);
                        var minAfterToday = DateTime.Today.AddDays(1);
                        var minDate = minAfterOriginal > minAfterToday ? minAfterOriginal : minAfterToday;
                    }

                    <div class="mb-3">
                        <label for="newDeparture-@booking.Id" class="form-label">Choose new Check-Out Date</label>
                        <input type="date" id="newDeparture-@booking.Id" class="form-control new-departure" data-booking-id="@booking.Id" min="@minDate.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="mb-2">Extended Nights: <strong id="extendedNights-@booking.Id">0</strong></div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="extendHiddenNewDeparture-@booking.Id" />
                    <input type="hidden" id="extendHiddenNights-@booking.Id" />
                    <!-- Instead of submitting immediately, open payment modal to pay for extension -->
                    <button type="button" class="btn btn-primary open-extend-payment-btn" data-booking-id="@booking.Id" id="extendNowBtn-@booking.Id" disabled>Extend Now</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend Payment Modal -->
    <div class="modal fade" id="extendPaymentModal-@booking.Id" tabindex="-1" aria-labelledby="extendPaymentModalLabel-@booking.Id" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="extendPaymentModalLabel-@booking.Id">Extend Payment - Booking @booking.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">New Check-Out Date: <strong id="extendDisplayNewDeparture-@booking.Id">@booking.DepartureDate.ToString("yyyy-MM-dd")</strong></div>
                    @{ var roomRatesInt = 0; int.TryParse(booking.RoomRates, out roomRatesInt); }
                    <div class="mb-3">Room Rate: <strong id="extendRoomRate-@booking.Id">@roomRatesInt.ToString("C0", new System.Globalization.CultureInfo("en-PH"))</strong></div>
                    <div class="mb-2">Extended Nights: <strong id="extendDisplayNights-@booking.Id">0</strong></div>
                    <div class="mb-3">Extended Price: <strong id="extendPrice-@booking.Id">@(0.ToString("C2", new System.Globalization.CultureInfo("en-PH")))</strong></div>
                     <div class="mb-3">
                        <label class="form-label">Booking Amount Paid</label>
                        @{ var paidRaw = 0.0; if (booking.CashPaidBooking is double cp) { paidRaw = cp; } }
                        <div id="extendBookingPaid-@booking.Id" data-initial-paid="@paidRaw" class="fw-bold">@(booking.CashPaidBooking is double cashPaid ? cashPaid.ToString("C2", new System.Globalization.CultureInfo("en-PH")) : "PHP 0.00")</div>
                    </div>

                    <div class="mb-3" id="payAmountContainer-@booking.Id">
                        <label for="payAmountInput-@booking.Id" class="form-label">Enter Pay Amount (this will be applied deduction discount to Booking Amount Paid)</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="payAmountInput-@booking.Id" />
                    </div>


                    <div class="mb-3">
                        <label class="form-label">Pay Amount (deduction discount)</label>
                        <div id="extendPayApplied-@booking.Id" class="fw-bold">@(0.ToString("C2", new System.Globalization.CultureInfo("en-PH")))</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Amount Change</label>
                        <div id="extendChangeDisplay-@booking.Id" class="fw-bold">@(0.ToString("C2", new System.Globalization.CultureInfo("en-PH")))</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <form asp-action="ExtendAndPay" asp-controller="System" method="post" id="extendPayForm-@booking.Id">
                        <input type="hidden" name="bookingId" value="@booking.Id" />
                        <input type="hidden" name="newDepartureDate" id="extendPayHiddenNewDeparture-@booking.Id" />
                        <input type="hidden" name="extendedNights" id="extendPayHiddenNights-@booking.Id" />
                        <input type="hidden" name="payAmount" id="extendPayHiddenAmount-@booking.Id" />
                        <input type="hidden" name="addedRemain" id="extendPayHiddenAddedRemain-@booking.Id" />
                        <input type="hidden" name="paidForExtension" id="extendPayHiddenPaidForExtension-@booking.Id" />
                        <button type="submit" class="btn btn-success" id="extendPayNowBtn-@booking.Id">Pay</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Direct checkout form for bookings (hidden). This uses booking's stored cash values so payment modal is skipped for Bookings -->
    <form asp-action="CheckOut" asp-controller="System" asp-route-bookingId="@booking.Id" method="post" id="directCheckoutForm-@booking.Id" style="display:none;">
        <input type="hidden" name="stayingDays" value="@stayingDays" />
        <input type="hidden" name="grandTotal" value="@total" />
        <input type="hidden" name="cashAmount" value="@booking.CashAmount" />
        <input type="hidden" name="cashChange" value="@booking.CashChange" />
    </form>
}

<!-- Customer Information -->
@foreach (var booking in Model)
{
    var stayingDays = (booking.DepartureDate - booking.ArrivalDate).Days; 
    <div class="modal fade" id="infoModal-@booking.Id" tabindex="-1" aria-labelledby="infoModalLabel-@booking.Id" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel-@booking.Id">Customer Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <dl class="row">
                        <dt class="col-sm-3">ID</dt>
                        <dd class="col-sm-9">@booking.Id</dd>
                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">@booking.Status</dd>
                        <dt class="col-sm-3">Book/Reserve</dt>
                        <dd class="col-sm-9">@booking.BookReserve</dd>
                    </dl>

                    <b>- Customer's Information -</b>
                    <dl class="row">
                        <dt class="col-sm-3">First Name</dt>
                        <dd class="col-sm-9">@booking.FirstName</dd>
                        <dt class="col-sm-3">Last Name</dt>
                        <dd class="col-sm-9">@booking.LastName</dd>
                        <dt class="col-sm-3">Middle Initial</dt>
                        <dd class="col-sm-9">@booking.MI</dd>
                        <dt class="col-sm-3">Address</dt>
                        <dd class="col-sm-9">@booking.Address</dd>
                        <dt class="col-sm-3">Email</dt>
                        <dd class="col-sm-9">@booking.Email</dd>
                        <dt class="col-sm-3">Contact Number</dt>
                        <dd class="col-sm-9">@booking.ContactNumber</dd>
                        <dt class="col-sm-3">Nationality</dt>
                        <dd class="col-sm-9">@booking.Nationality</dd>
                        <dt class="col-sm-3">Purpose</dt>
                        <dd class="col-sm-9">@booking.Purpose</dd>
                        <dt class="col-sm-3">Guest Names</dt>
                        <dd class="col-sm-9">@booking.GuestNames</dd>
                    </dl>

                    <b>- Room Information -</b>
                    <dl class="row">
                        <dt class="col-sm-3">Check-In Date</dt>
                        <dd class="col-sm-9">@booking.ArrivalDate.ToString("M/d/yy")</dd>
                        <dt class="col-sm-3">Check-Out Date</dt>
                        <dd class="col-sm-9">@booking.DepartureDate.ToString("M/d/yy")</dd>
                        <dt class="col-sm-3">Staying Days</dt>
                        <dd class="col-sm-9">@stayingDays.ToString()</dd>
                        <dt class="col-sm-3">Room Number</dt>
                        <dd class="col-sm-9">@booking.RoomNumber</dd>
                        <dt class="col-sm-3">Room Type</dt>
                        <dd class="col-sm-9">@booking.RoomType</dd>
                        <dt class="col-sm-3">Room Rates</dt>
                        <dd class="col-sm-9">@(Convert.ToDecimal(booking.RoomRates).ToString("C0", new System.Globalization.CultureInfo("en-PH")))</dd>
                        <dt class="col-sm-3">Number Of Pax</dt>
                        <dd class="col-sm-9">@booking.NumberOfPax</dd>          
                    </dl>


                    <dl class="row">
                        <dt class="col-sm-3">Booking Amount Paid</dt>
                        <dd class="col-sm-9" id="infoBookingPaid-@booking.Id">@(booking.CashPaidBooking is double cashPaidBooking ? cashPaidBooking.ToString("C2", new System.Globalization.CultureInfo("en-PH")) : "PHP 0.00")</dd>      
                        <dt class="col-sm-3">Total Amount Paid</dt>
                        <dd class="col-sm-9" id="infoTotalPaid-@booking.Id">@(booking.CashAmount is double cashAmount ? cashAmount.ToString("C2", new System.Globalization.CultureInfo("en-PH")) : "PHP 0.00")</dd>      
                        <dt class="col-sm-3">Total Amount Change</dt>
                        <dd class="col-sm-9" id="infoRemain-@booking.Id">@(booking.CashChange is double cashChange ? cashChange.ToString("C2", new System.Globalization.CultureInfo("en-PH")) : "PHP 0.00")</dd>      
                    </dl>

                    <dl class="row">
                        <dt class="col-sm-3">Controlled Access By</dt>
                        <dd class="col-sm-9">@booking.AccessBy</dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@if (TempData["CheckOutSuccess"] != null)
{
    // read formatted string from TempData (avoids serializing non-string types)
    var formattedChange = TempData["CashChangeFormatted"] as string;

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    Check Out Successfully and the room status was set to Maintainance.<br/>
                    @if (!string.IsNullOrEmpty(formattedChange))
                    {
                        <div class="mt-2"><strong>Your cash change is: @formattedChange</strong></div>
                    }
                    <!-- total staying days moved to extend success modal -->
                </div>
            </div>
        </div>
    </div>
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            var successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        });
        

        // Note: extend modal is shown by Bootstrap via data-bs attributes on the button
    </script>
    
}

<!-- Extend Success Modal template (cloned and shown by JS after successful extend payment) -->
@{
    int? stayingDaysFromTemp = null;
    if (TempData["StayingDays"] != null)
    {
        stayingDaysFromTemp = Convert.ToInt32(TempData["StayingDays"]);
    }
}
<div class="modal fade" id="extendSuccessModal" tabindex="-1" aria-labelledby="extendSuccessModalLabel" aria-hidden="true" style="display:none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="extendSuccessModalLabel">Extension Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div>Extension for Booking <strong class="es-bookingId"></strong> confirmed.</div>
                <div class="mt-2">New Check-Out Date: <strong class="es-newDate"></strong></div>
                <div>Extended Nights: <strong class="es-nights"></strong></div>
                <div class="mt-2">Total Staying Nights: <strong class="es-totalDays">@(stayingDaysFromTemp.HasValue ? stayingDaysFromTemp.Value.ToString() : "")</strong></div>
                ----------------------------------------------------------
                <div class="mt-2">Amount Paid: <strong class="es-amount"></strong></div>
                <div class="mt-2">Amount Change: <strong class="es-addedRemain"></strong></div>
            </div>
        </div>
    </div>
</div>

<!-- Centralized JS: hide checkout modal then show payment modal; handle payment input and validation -->
<script>
    (function () {
        var currencyFormatter = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP', currencyDisplay: 'narrowSymbol', maximumFractionDigits: 2 });

        // After a reload, show extend success modal if payload was saved to sessionStorage
        window.addEventListener('DOMContentLoaded', function () {
            try {
                var raw = sessionStorage.getItem('extendSuccessPayload');
                if (!raw) return;
                var payload = JSON.parse(raw);
                try { sessionStorage.removeItem('extendSuccessPayload'); } catch (e) { }

                var template = document.getElementById('extendSuccessModal');
                if (!template) return;

                // Clone template and show a fresh instance (avoids reusing the same DOM node)
                try {
                    var clone = template.cloneNode(true);
                    var unique = 'es_reload_' + ((payload && payload.bookingId) ? payload.bookingId + '_' : '') + new Date().getTime();
                    clone.id = 'extendSuccessModal_reload_' + unique;
                    clone.style.display = '';
                    clone.style.zIndex = 20000;

                    var bEl = clone.querySelector('.es-bookingId');
                    var ndEl = clone.querySelector('.es-newDate');
                    var nEl = clone.querySelector('.es-nights');
                    var amtEl = clone.querySelector('.es-amount');
                    var addEl = clone.querySelector('.es-addedRemain');
                    var tdEl = clone.querySelector('.es-totalDays');
                    var tsEl = clone.querySelector('.es-totalSpent');
                    var dateEl = clone.querySelector('.es-changeDate');

                    if (bEl) bEl.textContent = payload.bookingId || '';
                    if (ndEl) ndEl.textContent = payload.newDepartureDate || '';
                    if (nEl) nEl.textContent = (payload.extendedNights || '') + '';

                    try {
                        var arrivalEl = document.getElementById('arrivalDate-' + (payload.bookingId || ''));
                        if (arrivalEl && arrivalEl.textContent && (ndEl && ndEl.textContent) && tdEl) {
                            var arrival = new Date(arrivalEl.textContent + 'T00:00:00');
                            var newDep = new Date((payload.newDepartureDate || ndEl.textContent) + 'T00:00:00');
                            if (!isNaN(arrival.getTime()) && !isNaN(newDep.getTime())) {
                                var diffMs = newDep - arrival;
                                var days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                                tdEl.textContent = (days > 0 ? days : 0).toString();
                            }
                        }
                    } catch (e) { console.error(e); }

                    var displayAmount2 = 0;
                    try {
                        var domAppliedEl = document.getElementById('extendPayApplied-' + (payload.bookingId || ''));
                        if (domAppliedEl) {
                            var domAppliedNum = parseFloat((domAppliedEl.textContent || domAppliedEl.innerText || '').replace(/[^0-9.-]+/g, '')) || 0;
                            if (domAppliedNum > 0) displayAmount2 = domAppliedNum;
                        }
                    } catch (e) { }
                    if (typeof payload.totalPaid !== 'undefined' && payload.totalPaid !== null) displayAmount2 = payload.totalPaid;
                    else if (typeof payload.paidApplied !== 'undefined' && payload.paidApplied !== null && payload.paidApplied > 0) displayAmount2 = payload.paidApplied;
                    else if (typeof payload.paid !== 'undefined' && payload.paid !== null && payload.paid > 0) displayAmount2 = (typeof payload.extendedPrice !== 'undefined' && payload.extendedPrice !== null) ? Math.min(payload.paid, payload.extendedPrice) : payload.paid;
                    else if (typeof payload.totalSpent !== 'undefined' && payload.totalSpent !== null) displayAmount2 = payload.totalSpent;

                    if (amtEl) amtEl.textContent = currencyFormatter.format(displayAmount2 || 0);
                    if (addEl) addEl.textContent = currencyFormatter.format(payload.addedRemain || 0);
                    if (tsEl) tsEl.textContent = currencyFormatter.format((payload.totalSpent || payload.paid) || 0);
                    if (dateEl) dateEl.textContent = payload.cashChangeDate || '';

                                // remove any previous clones to avoid duplicate/backdrop conflicts
                                try {
                                    var prev = document.querySelectorAll("[id^='extendSuccessModal_clone_'],[id^='extendSuccessModal_reload_']");
                                    prev.forEach(function(p){ try{ p.remove(); } catch(e){} });
                                } catch(e){}
                                document.body.appendChild(clone);
                    var modalInst = new bootstrap.Modal(clone, { backdrop: true });
                    modalInst.show();
                    clone.addEventListener('hidden.bs.modal', function () { try { modalInst.dispose(); } catch (e) { } try { clone.remove(); } catch (e) { } }, { once: true });
                } catch (err) { console.error('show extend success failed (reload)', err); }
            } catch (ex) { console.error('extend success show failed', ex); }
        });

        // Open payment modal after hiding price modal, or directly submit for Bookings
        document.addEventListener('click', function (e) {
            var btn = e.target.closest('.open-payment-btn');
            if (!btn) return;

            var bookingId = btn.getAttribute('data-booking-id');
            if (!bookingId) return;

            var bookReserve = (btn.getAttribute('data-book-reserve') || '').toLowerCase();

            var checkoutEl = document.getElementById('checkoutPriceModal-' + bookingId);
            var paymentEl = document.getElementById('paymentModal-' + bookingId);

            // Hide checkout price modal if open
            try {
                var checkoutInstance = bootstrap.Modal.getInstance(checkoutEl);
                if (!checkoutInstance) checkoutInstance = bootstrap.Modal.getOrCreateInstance(checkoutEl);
                checkoutInstance.hide();
            } catch (err) {
                // ignore
            }

            // If this is a Booking (not a Reservation), skip payment modal and submit hidden direct checkout form
            if (bookReserve === 'booking') {
                var directForm = document.getElementById('directCheckoutForm-' + bookingId);
                if (directForm) {
                    // Submit the hidden form which posts stored cash values to the controller
                    directForm.submit();
                    return;
                }
            }

            // Otherwise show payment modal
            try {
                var paymentInstance = bootstrap.Modal.getOrCreateInstance(paymentEl);
                paymentInstance.show();

                // small delay to allow modal DOM to be active
                setTimeout(function () {
                    var cashInput = document.getElementById('cashAmount-' + bookingId);
                    if (cashInput) {
                        cashInput.focus();
                        updateChangeFor(bookingId);
                    }
                }, 120);
            } catch (err) {
                console.error(err);
            }
        });

        // Delegated handler to open extend modal (works even if data-bs attributes fail)
        document.addEventListener('click', function (e) {
            var btn = e.target.closest('.open-extend-btn');
            if (!btn) return;
            e.preventDefault();
            var bookingId = btn.getAttribute('data-booking-id');
            if (!bookingId) return;
            var extendEl = document.getElementById('extendModal-' + bookingId);
            if (!extendEl) return;
            try {
                var instance = bootstrap.Modal.getOrCreateInstance(extendEl);
                instance.show();
                // ensure computeExtendedNights runs to initialize state
                setTimeout(function () { computeExtendedNights(bookingId); }, 50);
            } catch (err) {
                console.error(err);
            }
        });

        // Open extend payment modal when clicking Extend Now
        document.addEventListener('click', function (e) {
            var btn = e.target.closest('.open-extend-payment-btn');
            if (!btn) return;
            var bookingId = btn.getAttribute('data-booking-id');
            if (!bookingId) return;

            // read computed values from extend modal hidden fields
            var hiddenNew = document.getElementById('extendHiddenNewDeparture-' + bookingId);
            var hiddenNights = document.getElementById('extendHiddenNights-' + bookingId);
            var extendModalEl = document.getElementById('extendModal-' + bookingId);
            if (!hiddenNew || !hiddenNights || !extendModalEl) return;

            var newDep = hiddenNew.value;
            var nights = parseInt(hiddenNights.value || '0');
            if (!newDep || nights <= 0) {
                alert('Please choose a valid new departure date and ensure extended nights is at least 1.');
                return;
            }

            // populate extend payment modal
            var payModalEl = document.getElementById('extendPaymentModal-' + bookingId);
            if (!payModalEl) return;
            document.getElementById('extendDisplayNewDeparture-' + bookingId).textContent = newDep;
            document.getElementById('extendDisplayNights-' + bookingId).textContent = nights.toString();
            document.getElementById('extendPayHiddenNewDeparture-' + bookingId).value = newDep;
            document.getElementById('extendPayHiddenNights-' + bookingId).value = nights;

            // get room rate
            var rateText = document.getElementById('extendRoomRate-' + bookingId).textContent || '';
            // strip non-digits to parse number
            var digits = rateText.replace(/[^0-9.-]+/g, '');
            var rate = parseFloat(digits || '0');
            var extendedPrice = Math.round(rate * nights);
            document.getElementById('extendPrice-' + bookingId).textContent = currencyFormatter.format(extendedPrice);

            // always require user to enter pay amount for extension
            var showPayment = function () {
                try {
                    var hiddenAmtEl = document.getElementById('extendPayHiddenAmount-' + bookingId);
                    // clear pay amount and hidden fields
                    var payInputEl = document.getElementById('payAmountInput-' + bookingId);
                    if (payInputEl) payInputEl.value = '';
                    if (hiddenAmtEl) hiddenAmtEl.value = '';
                    var hiddenPaidForExt = document.getElementById('extendPayHiddenPaidForExtension-' + bookingId);
                    var hiddenAddedRemain = document.getElementById('extendPayHiddenAddedRemain-' + bookingId);
                    if (hiddenPaidForExt) hiddenPaidForExt.value = '';
                    if (hiddenAddedRemain) hiddenAddedRemain.value = '';

                    // reset change display
                    try { var changeEl = document.getElementById('extendChangeDisplay-' + bookingId); if (changeEl) changeEl.textContent = currencyFormatter.format(0); } catch (e) { }

                    var instance = bootstrap.Modal.getOrCreateInstance(payModalEl);
                    // clear any previous "submitted" flag so Pay works repeatedly
                    try {
                        var formElem = document.getElementById('extendPayForm-' + bookingId);
                        if (formElem) {
                            delete formElem.dataset.submitted;
                            formElem.removeAttribute('data-submitted');
                        }
                    } catch (e) { }
                    instance.show();

                    // ensure Pay Now disabled initially until sufficient amount entered
                    var payNowBtn = document.getElementById('extendPayNowBtn-' + bookingId);
                    if (payNowBtn) payNowBtn.disabled = true;
                } catch (err) { console.error(err); }
            };

            // Hide the extend modal first to avoid backdrop/focus conflicts, then show payment modal
            try {
                var extendInst = bootstrap.Modal.getInstance(extendModalEl) || bootstrap.Modal.getOrCreateInstance(extendModalEl);
                extendInst.hide();
                // Wait for the modal to be fully hidden before showing the payment modal
                extendModalEl.addEventListener('hidden.bs.modal', function handler() {
                    extendModalEl.removeEventListener('hidden.bs.modal', handler);
                    showPayment();
                }, { once: true });
            } catch (err) {
                // fallback: show payment modal immediately
                console.error(err);
                showPayment();
            }
        });

        // No payment option radios: user must enter pay amount

        // when typing pay amount update hidden field
        document.addEventListener('input', function (e) {
            var target = e.target;
            if (!target) return;
            if (target.id && target.id.startsWith('payAmountInput-')) {
                var bookingId = target.id.split('-')[1];
                var hiddenAmt = document.getElementById('extendPayHiddenAmount-' + bookingId);
                if (hiddenAmt) hiddenAmt.value = target.value;
                var payNowBtn = document.getElementById('extendPayNowBtn-' + bookingId);
                var priceText = document.getElementById('extendPrice-' + bookingId).textContent || '';
                var price = parseFloat(priceText.replace(/[^0-9.-]+/g, '') || '0');
                var entered = parseFloat(target.value || '0');
                if (isNaN(price)) price = 0;
                if (isNaN(entered)) entered = 0;

                // booking paid comes from DB and is stored in data-initial-paid
                var bookingPaidEl = document.getElementById('extendBookingPaid-' + bookingId);
                var bookingPaidInit = 0;
                if (bookingPaidEl) bookingPaidInit = parseFloat(bookingPaidEl.getAttribute('data-initial-paid') || '0') || 0;

                // pay applied = entered - bookingPaid (show zero if negative)
                var applied = entered - bookingPaidInit;
                if (isNaN(applied) || applied < 0) applied = 0;
                // Display the applied deduction capped to the extended price so it represents
                // the actual amount that will be applied toward the extension (deduction)
                var appliedDisplay = applied;
                try { if (!isNaN(price) && price > 0) appliedDisplay = Math.min(applied, price); } catch (e) { }

                // enable pay when entered amount is at least the extended price
                if (payNowBtn) payNowBtn.disabled = entered < price;
                if (payNowBtn) payNowBtn.setAttribute('aria-disabled', (entered < price).toString());

                // update change display: extra = entered - price (customer change)
                try {
                    var changeEl = document.getElementById('extendChangeDisplay-' + bookingId);
                    var extra = entered - price;
                    if (isNaN(extra)) extra = 0;
                    if (changeEl) changeEl.textContent = currencyFormatter.format(extra > 0 ? extra : 0);
                } catch (err) { console.error(err); }

                // update Pay Applied display (deduction applied toward extension)
                try {
                    var payAppliedEl = document.getElementById('extendPayApplied-' + bookingId);
                    if (payAppliedEl) {
                        payAppliedEl.textContent = currencyFormatter.format(appliedDisplay);
                    }
                } catch (err) { console.error(err); }
            }
        });

        // computeExtendedNights updates extendHiddenNights and extendHiddenNewDeparture and enables the Extend Now button

        

        // Update change when typing into any cash input (delegated)
        document.addEventListener('input', function (e) {
            var target = e.target;
            if (!target) return;
            if (target.classList && target.classList.contains('cash-amount')) {
                var idParts = target.id.split('-');
                var bookingId = idParts[idParts.length - 1];
                updateChangeFor(bookingId);
            }

            // also handle new departure inputs for extend modal
            if (target.classList && target.classList.contains('new-departure')) {
                var bookingId = target.getAttribute('data-booking-id');
                if (bookingId) computeExtendedNights(bookingId);
            }
        });

        // Intercept submit on payment forms for validation
        document.addEventListener('submit', function (e) {
            var form = e.target;
            if (!form || !form.id || !form.id.startsWith('paymentForm-')) return;

            var bookingId = form.id.split('-')[1];
            var cashInput = document.getElementById('cashAmount-' + bookingId);
            var grandHidden = document.getElementById('grandTotalHidden-' + bookingId);
            var changeHidden = document.getElementById('cashChangeHidden-' + bookingId);
            var paid = parseFloat(cashInput && cashInput.value ? cashInput.value : '0');
            var total = parseFloat(grandHidden && grandHidden.value ? grandHidden.value : '0');

            if (isNaN(paid) || paid < total) {
                e.preventDefault();
                alert('Entered amount is less than the total. Please enter sufficient cash.');
                if (cashInput) cashInput.focus();
                return false;
            }

            var change = Math.round((paid - total) * 100) / 100;
            if (changeHidden) changeHidden.value = change;
            // allow submit
            return true;
        });

        // Intercept submit on extend payment forms: perform AJAX submit and update UI using the
        // visible "Pay Applied" deduction (extendPayApplied-<id>) to update Total Amount Paid.
        document.addEventListener('submit', function (e) {
            var form = e.target;
            if (!form || !form.id || !form.id.startsWith('extendPayForm-')) return;

            e.preventDefault();
            var bookingId = form.id.split('-')[1];
            if (!bookingId) return;

            var priceText = (document.getElementById('extendPrice-' + bookingId) && document.getElementById('extendPrice-' + bookingId).textContent) || '';
            var price = parseFloat(priceText.replace(/[^0-9.-]+/g, '') || '0') || 0;

            var hiddenAmtField = document.getElementById('extendPayHiddenAmount-' + bookingId);
            var payInput = document.getElementById('payAmountInput-' + bookingId);
            var payAmt = 0;
            if (hiddenAmtField && hiddenAmtField.value) payAmt = parseFloat(hiddenAmtField.value) || 0;
            if (payInput && payInput.value) payAmt = parseFloat(payInput.value) || payAmt;

            var bookingPaidEl = document.getElementById('extendBookingPaid-' + bookingId);
            var bookingPaidInit = 0;
            if (bookingPaidEl) bookingPaidInit = parseFloat(bookingPaidEl.getAttribute('data-initial-paid') || '0') || 0;

            var applied = payAmt - bookingPaidInit;
            if (isNaN(applied) || applied < 0) applied = 0;

            if (payAmt < price) {
                alert('Entered amount is less than the extended price. Please enter sufficient amount.');
                if (payInput) payInput.focus();
                return false;
            }

            var paidForExtension = Math.min(applied, price);
            var extra = payAmt - price;
            if (isNaN(extra) || extra < 0) extra = 0;

            var paidForExtField = document.getElementById('extendPayHiddenPaidForExtension-' + bookingId);
            var addedRemainField = document.getElementById('extendPayHiddenAddedRemain-' + bookingId);
            if (hiddenAmtField) hiddenAmtField.value = payAmt.toString();
            if (paidForExtField) paidForExtField.value = paidForExtension.toString();
            if (addedRemainField) addedRemainField.value = extra.toString();

            // Prevent duplicate submissions
            if (form.dataset.submitted) return;
            form.dataset.submitted = '1';

            var fd = new FormData(form);
            console.debug && console.debug('extendPay: sending AJAX', form.action || window.location.pathname, Array.from(fd.entries()));
            fetch(form.action || window.location.pathname, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (resp) {
                    if (!resp.ok) { form.submit(); return; }
                    return resp.json().catch(function () { return null; });
                }).then(function (json) {
                    if (json === null) json = {};
                    console.debug && console.debug('extendPay: server JSON', json);
                    if (json.hasOwnProperty('success') && !json.success) { form.submit(); return; }

                    // update remain
                    var infoRemainEl2 = document.getElementById('infoRemain-' + bookingId);
                    var remainRowEl = document.getElementById('remainDisplayRow-' + bookingId);
                    if (infoRemainEl2) {
                        var prevRemain = parseFloat((infoRemainEl2.textContent || '').replace(/[^0-9.-]+/g, '')) || 0;
                        var newRemain = Math.round((prevRemain + extra) * 100) / 100;
                        infoRemainEl2.textContent = currencyFormatter.format(newRemain);
                        if (remainRowEl) remainRowEl.textContent = infoRemainEl2.textContent;
                    }

                    // add visible pay-applied value to Total Amount Paid
                    var infoPaidEl = document.getElementById('infoTotalPaid-' + bookingId);
                    if (infoPaidEl) {
                        var prevPaid = parseFloat((infoPaidEl.textContent || infoPaidEl.innerText || '').replace(/[^0-9.-]+/g, '') || '0') || 0;
                        var payAppliedNumber = 0;
                        try {
                            var payAppliedEl = document.getElementById('extendPayApplied-' + bookingId);
                            if (payAppliedEl) payAppliedNumber = parseFloat((payAppliedEl.textContent || payAppliedEl.innerText || '').replace(/[^0-9.-]+/g, '')) || 0;
                        } catch (e) { payAppliedNumber = paidForExtension || 0; }

                        var newPaid = Math.round((prevPaid + payAppliedNumber) * 100) / 100;
                        infoPaidEl.textContent = currencyFormatter.format(newPaid);
                    }

                    // hide payment modal then show success modal after it is fully hidden to avoid backdrop/focus conflicts
                    var payModalEl = document.getElementById('extendPaymentModal-' + bookingId);

                    // Build payload for success modal (prefer server values)
                    try {
                        // Prefer server-provided 'paid' value. If missing, use the displayed "Pay Applied" (deduction)
                        // rather than the raw input amount. Compute a safe fallback if needed.
                        var payAppliedNumberLocal = 0;
                        try {
                            var payAppliedEl2 = document.getElementById('extendPayApplied-' + bookingId);
                            if (payAppliedEl2) payAppliedNumberLocal = parseFloat((payAppliedEl2.textContent || payAppliedEl2.innerText || '').replace(/[^0-9.-]+/g, '')) || 0;
                        } catch (e) { }

                        if (!payAppliedNumberLocal || payAppliedNumberLocal <= 0) {
                            // fallback: compute from entered pay amount minus bookingPaidInit, capped to price
                            var appliedCalc = payAmt - bookingPaidInit;
                            if (isNaN(appliedCalc) || appliedCalc < 0) appliedCalc = 0;
                            payAppliedNumberLocal = Math.min(appliedCalc, price || appliedCalc);
                        }

                        var payload = {
                            bookingId: json && json.bookingId ? json.bookingId : bookingId,
                            newDepartureDate: json && json.newDepartureDate ? json.newDepartureDate : (document.getElementById('extendPayHiddenNewDeparture-' + bookingId) && document.getElementById('extendPayHiddenNewDeparture-' + bookingId).value) || '',
                            extendedNights: json && json.extendedNights ? json.extendedNights : (document.getElementById('extendPayHiddenNights-' + bookingId) && document.getElementById('extendPayHiddenNights-' + bookingId).value) || '',
                            paid: (json && typeof json.paid !== 'undefined') ? json.paid : (payAppliedNumberLocal || paidForExtension || 0),
                            // explicit applied amount (deduction from booking paid)
                            paidApplied: (json && typeof json.paid !== 'undefined') ? json.paid : payAppliedNumberLocal || paidForExtension || 0,
                            extendedPrice: (json && typeof json.extendedPrice !== 'undefined') ? json.extendedPrice : price,
                            addedRemain: (json && typeof json.addedRemain !== 'undefined') ? json.addedRemain : extra,
                            newCashChange: (json && typeof json.newCashChange !== 'undefined') ? json.newCashChange : (function() { var curRemain = document.getElementById('infoRemain-' + bookingId); if (curRemain) return parseFloat((curRemain.textContent || '').replace(/[^0-9.-]+/g, '')) || 0; return 0; })(),
                            cashChangeDate: (json && json.cashChangeDate) ? json.cashChangeDate : new Date().toISOString(),
                            totalPaid: (json && typeof json.totalPaid !== 'undefined') ? json.totalPaid : null,
                            totalSpent: (json && typeof json.totalSpent !== 'undefined') ? json.totalSpent : (payAppliedNumberLocal || paidForExtension || 0)
                        };

                        console.debug && console.debug('extendPay: building payload', payload);
                        // Show extend success modal by populating the template and showing it
                        // Show extend success modal after closing the extend payment modal to avoid backdrop/focus conflicts.
                        var showSuccessModal = function () {
                            var template = document.getElementById('extendSuccessModal');
                            console.debug && console.debug('extend success payload (AJAX)', payload, 'templateExists=', !!template);
                            if (!template) return;

                            try {
                                // Clone the template so we don't reuse the same node and can safely remove it later.
                                var clone = template.cloneNode(true);
                                clone.id = 'extendSuccessModal_clone_' + (payload.bookingId || '') + '_' + new Date().getTime();
                                clone.style.display = '';
                                clone.style.zIndex = 20000;

                                var bEl = clone.querySelector('.es-bookingId');
                                var ndEl = clone.querySelector('.es-newDate');
                                var nEl = clone.querySelector('.es-nights');
                                var amtEl = clone.querySelector('.es-amount');
                                var addEl = clone.querySelector('.es-addedRemain');
                                var tdEl = clone.querySelector('.es-totalDays');
                                var tsEl = clone.querySelector('.es-totalSpent');
                                var dateEl2 = clone.querySelector('.es-changeDate');

                                if (bEl) bEl.textContent = payload.bookingId || '';
                                if (ndEl) ndEl.textContent = payload.newDepartureDate || '';
                                if (nEl) nEl.textContent = (payload.extendedNights || '') + '';

                                try {
                                    var arrivalEl = document.getElementById('arrivalDate-' + (payload.bookingId || ''));
                                    if (arrivalEl && arrivalEl.textContent && (ndEl && ndEl.textContent) && tdEl) {
                                        var arrival = new Date(arrivalEl.textContent + 'T00:00:00');
                                        var newDep = new Date((payload.newDepartureDate || ndEl.textContent) + 'T00:00:00');
                                        if (!isNaN(arrival.getTime()) && !isNaN(newDep.getTime())) {
                                            var diffMs = newDep - arrival;
                                            var days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                                            tdEl.textContent = (days > 0 ? days : 0).toString();
                                        }
                                    }
                                } catch (e) { console.error(e); }

                                var displayAmount2 = 0;
                                try {
                                    var domAppliedEl = document.getElementById('extendPayApplied-' + (payload.bookingId || ''));
                                    if (domAppliedEl) {
                                        var domAppliedNum = parseFloat((domAppliedEl.textContent || domAppliedEl.innerText || '').replace(/[^0-9.-]+/g, '')) || 0;
                                        if (domAppliedNum > 0) displayAmount2 = domAppliedNum;
                                    }
                                } catch (e) { }
                                if (typeof payload.totalPaid !== 'undefined' && payload.totalPaid !== null) displayAmount2 = payload.totalPaid;
                                else if (typeof payload.paidApplied !== 'undefined' && payload.paidApplied !== null && payload.paidApplied > 0) displayAmount2 = payload.paidApplied;
                                else if (typeof payload.paid !== 'undefined' && payload.paid !== null && payload.paid > 0) displayAmount2 = (typeof payload.extendedPrice !== 'undefined' && payload.extendedPrice !== null) ? Math.min(payload.paid, payload.extendedPrice) : payload.paid;
                                else if (typeof payload.totalSpent !== 'undefined' && payload.totalSpent !== null) displayAmount2 = payload.totalSpent;

                                if (amtEl) amtEl.textContent = currencyFormatter.format(displayAmount2 || 0);
                                if (addEl) addEl.textContent = currencyFormatter.format(payload.addedRemain || 0);
                                if (tsEl) tsEl.textContent = currencyFormatter.format((payload.totalSpent || payload.paid) || 0);
                                if (dateEl2) dateEl2.textContent = payload.cashChangeDate || '';

                                // remove any previous clones to avoid duplicate/backdrop conflicts
                                try {
                                    var prev = document.querySelectorAll("[id^='extendSuccessModal_clone_'],[id^='extendSuccessModal_reload_']");
                                    prev.forEach(function(p){ try{ p.remove(); } catch(e){} });
                                } catch(e){}

                                document.body.appendChild(clone);
                                var modalInst = new bootstrap.Modal(clone, { backdrop: true });
                                modalInst.show();
                                clone.addEventListener('hidden.bs.modal', function () { try { modalInst.dispose(); } catch (e) { } try { clone.remove(); } catch (e) { } }, { once: true });
                            } catch (err) { console.error('show extend success failed', err); }
                        };

                        // Save payload to sessionStorage and reload immediately so the page shows
                        // the extend success modal after reload (handled in DOMContentLoaded).
                        try {
                            try {
                                sessionStorage.setItem('extendSuccessPayload', JSON.stringify(payload));
                                // reload the page immediately; the DOMContentLoaded handler will show the modal
                                window.location.reload();
                                return;
                            } catch (e) {
                                console.error('sessionStorage or reload failed', e);
                            }

                            // Fallback: if reload or sessionStorage isn't available, show success modal now
                            if (payModalEl) {
                                var payInst = bootstrap.Modal.getInstance(payModalEl) || bootstrap.Modal.getOrCreateInstance(payModalEl);
                                payInst.hide();
                                payModalEl.addEventListener('hidden.bs.modal', function handler() {
                                    payModalEl.removeEventListener('hidden.bs.modal', handler);
                                    showSuccessModal();
                                }, { once: true });
                            } else {
                                showSuccessModal();
                            }
                        } catch (err) {
                            console.error(err);
                            try { showSuccessModal(); } catch (e) { }
                        }
                    } catch (ex2) { console.error('show extend success failed', ex2); }

                    // clear submitted flag so user can retry later
                    try { delete form.dataset.submitted; form.removeAttribute && form.removeAttribute('data-submitted'); } catch (e) { }
                }).catch(function (err) { console.error(err); form.submit(); });

            return false;
        });

        // helper to update change and display
        function updateChangeFor(bookingId) {
            var cashInput = document.getElementById('cashAmount-' + bookingId);
            var displayChange = document.getElementById('displayChange-' + bookingId);
            var changeHidden = document.getElementById('cashChangeHidden-' + bookingId);
            var grandHidden = document.getElementById('grandTotalHidden-' + bookingId);

            var total = parseFloat(grandHidden && grandHidden.value ? grandHidden.value : '0');
            var paid = parseFloat(cashInput && cashInput.value ? cashInput.value : '0');
            if (isNaN(total)) total = 0;
            if (isNaN(paid)) paid = 0;

            var change = Math.round((paid - total) * 100) / 100;
            if (changeHidden) changeHidden.value = change;
            if (displayChange) displayChange.textContent = currencyFormatter.format(change < 0 ? 0 : change);
        }

        // compute extended nights for extend modal
        function computeExtendedNights(bookingId) {
            var newDep = document.getElementById('newDeparture-' + bookingId);
            var origDepEl = document.getElementById('originalDeparture-' + bookingId);
            var extendedEl = document.getElementById('extendedNights-' + bookingId);
            var hiddenNew = document.getElementById('extendHiddenNewDeparture-' + bookingId);
            var hiddenNights = document.getElementById('extendHiddenNights-' + bookingId);
            var btn = document.getElementById('extendNowBtn-' + bookingId);

            if (!newDep || !origDepEl || !extendedEl || !hiddenNew || !hiddenNights || !btn) return;

            // orig text is yyyy-MM-dd
            var orig = new Date(origDepEl.textContent + 'T00:00:00');
            var chosen = new Date(newDep.value + 'T00:00:00');
            if (isNaN(chosen.getTime()) || chosen <= orig) {
                extendedEl.textContent = '0';
                hiddenNights.value = 0;
                hiddenNew.value = '';
                btn.disabled = true;
                return;
            }

            var diffMs = chosen - orig;
            var nights = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (nights < 1) nights = 0;
            extendedEl.textContent = nights.toString();
            hiddenNights.value = nights;
            hiddenNew.value = newDep.value;
            btn.disabled = nights === 0;
        }

        // Removed delegated click handler for extendPayNowBtn: form submit handler below handles AJAX
    })();
</script>