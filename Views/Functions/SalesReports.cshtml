@model List<BRMSBS_capstoneproject.Models.PurchaseModel>
@{
    ViewData["Title"] = "Logs History";
    Layout = "~/Views/Layouts/SalesReportsLayout.cshtml";
    var modalCustomerId = -1;

    var totalBooked = Model.Count(c => c.Status == "Purchased" && c.BookReserve == "Booking");
    var totalReserved = Model.Count(c => c.Status == "Purchased" && c.BookReserve == "Reservation");
    var totalCancelled = Model.Count(c => c.Status == "Cancelled");
}
<div class="text-ctr"><b> Logs History </b></div>

<div class="containerbox" id="reportContent">
    <h3>
        Total Lists: @Model.Count() |
        Total Booked: @totalBooked |
        Total Reserved: @totalReserved |
        Total Cancelled: @totalCancelled
    </h3>

    <br/>

    <button type="button" class="btn btn-success no-print" id="printReportBtn" onclick="printReport()">Print Report</button>

    <br/>

    <div class="containerbox-2">
        <table class="table">
            <thead>
                <tr>
                    <th>Actions</th>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Room Number</th>
                    <th>Room Type</th>
                    <th>Total Amount</th>
                    <th>Cash Amount</th>
                    <th>Change Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var customer in Model)
                    {
                        <tr>
                            <td>
                                <button type="button" class="btn btn-outline-success" onclick="showOptionsModal(@customer.Id, '@customer.FirstName', '@customer.LastName')">
                                    Options
                                </button>
                            </td>
                            <td>@customer.Id</td>
                            <td>@customer.FirstName</td>
                            <td>@customer.LastName</td>
                            <td>@customer.RoomNumber</td>
                            <td>@customer.RoomType</td>
                            <td>@customer.GrandAmount.ToString("C")</td>
                            <td>@customer.CashAmount.ToString("C")</td>
                            <td>@customer.CashChange.ToString("C")</td>
                            <td>@customer.Status</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="12" class="text-center">No purchase/cancellation history data.</td>
                    </tr>
                } 
            </tbody>
        </table>
    </div>

    <!-- Print column view (hidden on screen, shown for print) -->
    <div id="printColumnView" style="display:none;">
        @if (Model != null && Model.Any())
        {
            @foreach (var c in Model)
            {
                <div class="print-card">
                    <h4>Record — @c.FirstName @c.LastName</h4>
                    <dl class="row print-dl">
                        <dt class="col-sm-4">ID</dt><dd class="col-sm-8">@c.Id</dd>
                        <dt class="col-sm-4">First Name</dt><dd class="col-sm-8">@c.FirstName</dd>
                        <dt class="col-sm-4">Last Name</dt><dd class="col-sm-8">@c.LastName</dd>
                        <dt class="col-sm-4">Room Number</dt><dd class="col-sm-8">@c.RoomNumber</dd>
                        <dt class="col-sm-4">Room Type</dt><dd class="col-sm-8">@c.RoomType</dd>
                        <dt class="col-sm-4">Total Amount</dt><dd class="col-sm-8">@c.GrandAmount.ToString("C")</dd>
                        <dt class="col-sm-4">Cash Amount</dt><dd class="col-sm-8">@c.CashAmount.ToString("C")</dd>
                        <dt class="col-sm-4">Change Amount</dt><dd class="col-sm-8">@c.CashChange.ToString("C")</dd>
                        <dt class="col-sm-4">Status</dt><dd class="col-sm-8">@c.Status</dd>
                    </dl>
                    <hr />
                </div>
            }
        }
    </div>
</div>

<!-- Modal Popup (outside table code) -->
<div class="modal fade" id="optionsModal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optionsModalLabel">Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="modalCustomerName"></div>
                <button type="button" class="btn btn-primary" id="viewDetailsBtn" onclick="showDetailsModal()">View Details</button>
                <button type="button" class="btn btn-danger" onclick="showDeleteConfirmModal()">Delete this data</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Are you sure you want to delete this data?<br/>
                    This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post" asp-action="DeleteCustomer" asp-controller="System">
                    <input type="hidden" name="customerId" id="deleteCustomerId" value="" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

@foreach (var customer in Model.Where(c => c.Status == "Purchased" || c.Status == "Cancelled"))
{
    var roomRates = Convert.ToInt32(customer.RoomRates);
    var numberOfPax = Convert.ToInt32(customer.NumberOfPax);
    var stayingDays = (customer.DepartureDate - customer.ArrivalDate).Days;
    var grandTotal = roomRates * stayingDays;
    <div class="modal fade" id="detailsModal-@customer.Id" tabindex="-1" aria-labelledby="detailsModalLabel-@customer.Id" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="printContent-@customer.Id">
                <div class="modal-header">
                    <div id="printHeader-@customer.Id">
                        <h5 class="modal-title" id="detailsModalLabel-@customer.Id">Room Rate Details</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <dl class="row">
                        <dt class="col-sm-3">First Name</dt>
                        <dd class="col-sm-9">@customer.FirstName</dd>
                        <dt class="col-sm-3">Last Name</dt>
                        <dd class="col-sm-9">@customer.LastName</dd>
                        <dt class="col-sm-3">MI</dt>
                        <dd class="col-sm-9">@customer.MI</dd>
                        <dt class="col-sm-3">Address</dt>
                        <dd class="col-sm-9">@customer.Address</dd>
                        <dt class="col-sm-3">Email</dt>
                        <dd class="col-sm-9">@customer.Email</dd>
                        <dt class="col-sm-3">Contact Number</dt>
                        <dd class="col-sm-9">@customer.ContactNumber</dd>
                        <dt class="col-sm-3">Nationality</dt>
                        <dd class="col-sm-9">@customer.Nationality</dd>
                        <dt class="col-sm-3">Purpose</dt>
                        <dd class="col-sm-9">@customer.Purpose</dd>
                    </dl class="row">

                    ------------------------------------------------------------------

                    <dl class="row">
                        <dt class="col-sm-3">Arrival Date</dt>
                        <dd class="col-sm-9">@customer.ArrivalDate.ToString("yyyy-MM-dd")</dd>
                        <dt class="col-sm-3">Departure Date</dt>
                        <dd class="col-sm-9">@customer.DepartureDate.ToString("yyyy-MM-dd")</dd>
                        <dt class="col-sm-3">Room Number</dt>
                        <dd class="col-sm-9">@customer.RoomNumber</dd>
                        <dt class="col-sm-3">Room Type</dt>
                        <dd class="col-sm-9">@customer.RoomType</dd>
                    </dl>

                    ------------------------------------------------------------------

                    <dl class="row">
                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">@customer.Status</dd>
                        <dt class="col-sm-3">Book/Reserve</dt>
                        <dd class="col-sm-9">@customer.BookReserve</dd>
                        <dt class="col-sm-4">Submitted ID</dt>
                        <dd class="col-sm-10">@customer.Id</dd>
                        <dt class="col-sm-7">Submitted Check Out/Cancellation</dt>
                        <dd class="col-sm-15">@customer.CheckOutDateTime</dd>
                    </dl>

                    ------------------------------------------------------------------

                    <dl class="row">       
                        <dt class="col-sm-5">Room Rates</dt>
                        <dd class="col-sm-9">@roomRates.ToString("C")</dd>
                        <dt class="col-sm-5">Number of Pax (Capacity)</dt>
                        <dd class="col-sm-9">@numberOfPax</dd>
                        <dt class="col-sm-5">Staying Days</dt>
                        <dd class="col-sm-9">@customer.StayingDays</dd>
                        <dt class="col-sm-5">Total Amount</dt>
                        <dd class="col-sm-9"><b>@grandTotal.ToString("C")</b></dd>
                        <dt class="col-sm-5">Cash Amount</dt>
                        <dd class="col-sm-9"><b>@customer.CashAmount.ToString("C")</b></dd>
                        <dt class="col-sm-5">Change Amount</dt>
                        <dd class="col-sm-9"><b>@customer.CashChange.ToString("C")</b></dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-secondary" onclick="printDetails('printContent-@customer.Id')">Print</button>
                </div>
            </div>
        </div>
    </div>
}

@if (TempData["CustomerDeleted"] != null)
{
    <div class="modal fade" id="deleteSuccessModal" tabindex="-1" aria-labelledby="deleteSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="deleteSuccessModalLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    Customer data has been deleted successfully.
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = new bootstrap.Modal(document.getElementById('deleteSuccessModal'));
            modal.show();
            setTimeout(function () {
                modal.hide();
            }, 2000);
        });
    </script>
}

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <style>
        /* Column/label view styles for the print cards */
        #printColumnView .print-card { margin-bottom: 18px; page-break-inside: avoid; }
        #printColumnView .print-dl dt { font-weight: 700; }
        #printColumnView .print-dl dd { margin-left: 0; }
        .no-print { display: inline-block; }

        /* Ensure print view looks like columns on the printed page */
        @@media print {
            /* hide everything except the print column view container */
            body * { visibility: hidden; }
            #printColumnView, #printColumnView * { visibility: visible; }
            #printColumnView { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var selectedCustomerId = null;

        function showOptionsModal(customerId, firstName, lastName) {
            selectedCustomerId = customerId;
            var modal = new bootstrap.Modal(document.getElementById('optionsModal'));
            modal.show();
        }

        function showDetailsModal() {
            if (selectedCustomerId !== null) {
                var detailsModal = new bootstrap.Modal(document.getElementById('detailsModal-' + selectedCustomerId));
                detailsModal.show();
            }
        }

        function showDeleteConfirmModal() {
            if (selectedCustomerId !== null) {
                document.getElementById('deleteCustomerId').value = selectedCustomerId;
                var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
            }
        }

        function printDetails(contentId) {
            var printContent = document.getElementById(contentId);

            // Swap header to custom receipt info if header exists
            var headerDiv = printContent.querySelector('[id^="printHeader-"]');
            var originalHeader = headerDiv ? headerDiv.innerHTML : null;
            if (headerDiv) {
                headerDiv.innerHTML = `
                    <div style="text-align:center;">
                        <h2>Balay Sidlakan Inc.<br/>Hotel and Lodging</h2>
                        <div>DS Regner Bldg. 92-C East Capitol Road<br/>Cebu City</div>
                        <hr>
                    </div>

                    <h2>Customer Receipt</h2>
                `;
            }

            // Hide modal-footer buttons before printing
            var modalFooter = printContent.querySelector('.modal-footer');
            if (modalFooter) {
                var buttons = modalFooter.querySelectorAll('button');
                buttons.forEach(btn => btn.style.display = 'none');
            }

            // Print logic
            var printContents = printContent.innerHTML;
            var originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload();

            // Restore original header
            if (headerDiv && originalHeader) {
                headerDiv.innerHTML = originalHeader;
            }
        }

        // New: print report in column (label/value) view
        function printReport() {
            var tableContainer = document.querySelector('.containerbox-2');
            var printView = document.getElementById('printColumnView');
            var printBtn = document.getElementById('printReportBtn');

            // show print-only column view and hide on-screen table and controls
            if (tableContainer) tableContainer.style.display = 'none';
            if (printBtn) printBtn.style.display = 'none';
            if (printView) printView.style.display = 'block';

            // trigger print
            window.print();

            // restore screen UI after printing
            if (printView) printView.style.display = 'none';
            if (tableContainer) tableContainer.style.display = '';
            if (printBtn) printBtn.style.display = '';
        }
    </script>
}